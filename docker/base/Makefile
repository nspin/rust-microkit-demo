work_root := ..

id := rust-sel4-sel4cp-demo
image_tag := $(id)
container_name := $(id)

.PHONY: none
none:

.PHONY: build
build:
	docker build \
		-t $(image_tag) .

# These targets might not even be needed
.PHONY: run
run: build
	docker run -d --name $(container_name) \
		--mount type=bind,src=$(abspath $(work_root)),dst=/work \
		$(image_tag) sleep inf

.PHONY: exec
exec:
	docker exec -it $(container_name) bash

.PHONY: rm-container
rm-container:
	for id in $$(docker ps -aq -f "name=^$(container_name)$$"); do \
		docker rm -f $$id; \
	done

.PHONY: test
test: build
	docker run --rm \
		--mount type=bind,readonly,src=$(abspath ..),dst=/work \
		-i $(image_tag) \
		make test BUILD=/tmp/build
